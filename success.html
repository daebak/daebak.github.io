<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HizBee | ê²°ì œ ì„±ê³µ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --primary-color: #38bdf8; /* ë¼ì´íŠ¸ ë¸”ë£¨ */
            --dark-color: #0b1120; /* ë‹¤í¬ ë„¤ì´ë¹„ ë°°ê²½ */
            --light-color: #1e293b; /* ì¹´ë“œ ë“± ë³´ì¡° ë°°ê²½ */
            --text-color: #e2e8f0; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ (ë°ì€ íšŒìƒ‰) */
            --text-light: #94a3b8; /* ë³´ì¡° í…ìŠ¤íŠ¸ (íšŒìƒ‰) */
            --border-color: #334155;
            --white-color: #ffffff;
            --success-color: #4ade80; /* ì„±ê³µ ì´ˆë¡ìƒ‰ */
            --error-color: #f87171; /* ì‹¤íŒ¨ ë¹¨ê°„ìƒ‰ */
        }
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--dark-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .header-logo {
            height: 30px;
            margin-bottom: 2rem;
        }
        .container {
            background-color: var(--light-color);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 600px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        h1 {
            color: var(--success-color);
            margin-bottom: 1rem;
            font-size: 2rem;
        }
        p {
            margin-bottom: 1rem;
            color: var(--text-light);
        }
        .info-block {
            background-color: var(--dark-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: left;
            border: 1px solid var(--border-color);
            font-size: 0.95em;
        }
        .info-block strong {
            color: var(--primary-color);
            display: inline-block;
            min-width: 100px;
        }
        .info-block span {
            color: var(--text-color);
        }
        .info-block .status-success {
            color: var(--success-color);
            font-weight: bold;
        }
        .info-block .status-error {
            color: var(--error-color);
            font-weight: bold;
        }
        .btn {
            display: inline-block;
            padding: 0.8rem 1.8rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(90deg, #38bdf8, #3b82f6);
            color: var(--white-color);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        #loadingMessage { display: block; margin-bottom: 1.5rem; color: var(--primary-color); font-weight: 500; }
        #approvalResultBlock { display: none; }
        .footer-link {
            margin-top: 2rem;
            font-size: 0.9rem;
        }
        .footer-link a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .footer-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="index.html">
        <img src="./ì•„ì´ì½˜(ë°˜ë°˜).png" alt="HizBee ë¡œê³ " class="header-logo" />
    </a>
    <div class="container">
        <h1>ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘</h1>
        <p id="statusMessage">Toss Paymentsì™€ ê²°ì œ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>

        <div id="initialInfoBlock" class="info-block">
            <p><strong>ì£¼ë¬¸ ID:</strong> <span id="orderIdDisplay"></span></p>
            <p><strong>ê²°ì œ ì˜ˆì • ê¸ˆì•¡:</strong> <span id="amountDisplay"></span> ì›</p>
            <p><strong>Payment Key:</strong> <span id="paymentKeyDisplay" style="word-break: break-all;"></span></p>
        </div>

        <p id="loadingMessage">ì„œë²„ë¡œ ìŠ¹ì¸ ìš”ì²­ì„ ë³´ë‚´ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>

        <div id="approvalResultBlock" class="info-block">
            <p><strong>ìŠ¹ì¸ ìƒíƒœ:</strong> <span id="approvalStatusDisplay"></span></p>
            <p><strong>ì£¼ë¬¸ëª…:</strong> <span id="orderNameDisplay"></span></p>
            <p><strong>ìµœì¢… ê²°ì œ ê¸ˆì•¡:</strong> <span id="finalAmountDisplay"></span></p>
            <p><strong>ê²°ì œ ìˆ˜ë‹¨:</strong> <span id="paymentMethodDisplay"></span></p>
            <p id="errorCodeBlock" style="display:none;"><strong>ì˜¤ë¥˜ ì½”ë“œ:</strong> <span id="errorCodeDisplay" class="status-error"></span></p>
            <p id="errorMessageBlock" style="display:none;"><strong>ì˜¤ë¥˜ ë©”ì‹œì§€:</strong> <span id="errorMessageDisplay" class="status-error"></span></p>
        </div>

        <a href="index.html" id="homeButton" class="btn btn-primary" style="display:none;">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
     <div class="footer-link">
        <a href="payment.html" id="retryLink" style="display:none;">&larr; ê²°ì œ ë‹¤ì‹œ ì‹œë„í•˜ê¸°</a>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const paymentKey = urlParams.get('paymentKey'); // Toss Paymentsê°€ successUrlì— ì¶”ê°€í•˜ëŠ” íŒŒë¼ë¯¸í„°
        const orderIdFromQuery = urlParams.get('orderId'); // payment.htmlì—ì„œ ì „ë‹¬í•œ íŒŒë¼ë¯¸í„°
        const amountFromQuery = urlParams.get('amount');   // payment.htmlì—ì„œ ì „ë‹¬í•œ íŒŒë¼ë¯¸í„°

        // í™”ë©´ ìš”ì†Œ
        const statusMessage = document.getElementById('statusMessage');
        const orderIdDisplay = document.getElementById('orderIdDisplay');
        const amountDisplay = document.getElementById('amountDisplay');
        const paymentKeyDisplay = document.getElementById('paymentKeyDisplay');
        const loadingMessage = document.getElementById('loadingMessage');
        const approvalResultBlock = document.getElementById('approvalResultBlock');
        const approvalStatusDisplay = document.getElementById('approvalStatusDisplay');
        const orderNameDisplay = document.getElementById('orderNameDisplay');
        const finalAmountDisplay = document.getElementById('finalAmountDisplay');
        const paymentMethodDisplay = document.getElementById('paymentMethodDisplay');
        const errorCodeBlock = document.getElementById('errorCodeBlock');
        const errorCodeDisplay = document.getElementById('errorCodeDisplay');
        const errorMessageBlock = document.getElementById('errorMessageBlock');
        const errorMessageDisplay = document.getElementById('errorMessageDisplay');
        const homeButton = document.getElementById('homeButton');
        const retryLink = document.getElementById('retryLink');
        const h1Title = document.querySelector('h1');

        // ì´ˆê¸° ì •ë³´ í‘œì‹œ
        orderIdDisplay.textContent = orderIdFromQuery || 'N/A';
        amountDisplay.textContent = amountFromQuery ? parseInt(amountFromQuery).toLocaleString() : 'N/A';
        paymentKeyDisplay.textContent = paymentKey || 'ì •ë³´ ì—†ìŒ (Toss Paymentsë¡œë¶€í„° ì „ë‹¬ë˜ì§€ ì•ŠìŒ)';

        async function approvePayment() {
            if (!paymentKey || !orderIdFromQuery || !amountFromQuery) {
                h1Title.textContent = 'ê²°ì œ ì •ë³´ ì˜¤ë¥˜';
                h1Title.style.color = 'var(--error-color)';
                statusMessage.textContent = 'ê²°ì œ ìŠ¹ì¸ì— í•„ìš”í•œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                loadingMessage.style.display = 'none';
                homeButton.style.display = 'inline-block';
                retryLink.href = `payment.html`; // íŒŒë¼ë¯¸í„° ì—†ì´ payment.htmlë¡œ (ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•¨)
                retryLink.style.display = 'inline-block';
                console.error('Missing paymentKey, orderId, or amount for approval.');
                return;
            }

            // í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ í‚¤ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ ì•ˆì „í•˜ê²Œ ê´€ë¦¬)
            const secretKey = "test_sk_D5GePWvyJnrK0W0k6q8gLzN97Eoq";
            const encodedSecretKey = btoa(`${secretKey}:`); // ë¸Œë¼ìš°ì € í™˜ê²½ì´ë¯€ë¡œ btoa ì‚¬ìš©

            try {
                // ì‹¤ì œ Toss Payments ìŠ¹ì¸ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ëŒ€ì‹  ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
                // ë°±ì—”ë“œ ì—†ì´ í”„ë¡ íŠ¸ì—ì„œ ì§ì ‘ Toss APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ë³´ì•ˆìƒ ë§¤ìš° ìœ„í—˜í•˜ë©°, CORS ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë©ë‹ˆë‹¤.

                loadingMessage.textContent = 'ê²°ì œ ìŠ¹ì¸ ì‹œë®¬ë ˆì´ì…˜ ì¤‘... (ì‹¤ì œ API í˜¸ì¶œì€ ë°±ì—”ë“œì—ì„œ)';
                await new Promise(resolve => setTimeout(resolve, 2500)); // ì‹œë®¬ë ˆì´ì…˜ ë”œë ˆì´

                const isSuccess = Math.random() > 0.2; // 80% ì„±ê³µ í™•ë¥  ì‹œë®¬ë ˆì´ì…˜
                let simulationResponse;

                if (isSuccess) {
                    simulationResponse = {
                        status: "DONE", // ì‹¤ì œ ì„±ê³µ ì‹œ ì£¼ìš” ìƒíƒœ
                        orderId: orderIdFromQuery,
                        orderName: `í”Œëœ ${orderIdFromQuery.slice(-4)} êµ¬ë… (ì‹œë®¬ë ˆì´ì…˜)`,
                        totalAmount: parseInt(amountFromQuery),
                        method: "ì¹´ë“œ", // ì˜ˆì‹œ
                        card: { company: "ì‹œë®¬ë ˆì´ì…˜ ì¹´ë“œì‚¬", number: "1234-****-****-5678" },
                        paymentKey: paymentKey // ë°›ì€ paymentKey ë‹¤ì‹œ í¬í•¨
                    };

                    h1Title.textContent = 'ğŸ‰ ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ';
                    h1Title.style.color = 'var(--success-color)';
                    statusMessage.textContent = 'ê³ ê°ë‹˜ì˜ ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    approvalStatusDisplay.textContent = 'ìŠ¹ì¸ ì™„ë£Œ (ì‹œë®¬ë ˆì´ì…˜)';
                    approvalStatusDisplay.className = 'status-success';
                    orderNameDisplay.textContent = simulationResponse.orderName;
                    finalAmountDisplay.textContent = simulationResponse.totalAmount.toLocaleString() + ' ì›';
                    paymentMethodDisplay.textContent = `${simulationResponse.method} (${simulationResponse.card.company} ${simulationResponse.card.number})`;
                    console.log("ê²°ì œ ìŠ¹ì¸ ì„±ê³µ (ì‹œë®¬ë ˆì´ì…˜):", simulationResponse);

                } else {
                    simulationResponse = {
                        code: "PAYMENT_REJECTED_SIMULATED",
                        message: "ì¹´ë“œ í•œë„ ì´ˆê³¼ ë˜ëŠ” ì‚¬ìš© ë¶ˆê°€ ì¹´ë“œì…ë‹ˆë‹¤ (ì‹œë®¬ë ˆì´ì…˜).",
                        orderId: orderIdFromQuery
                    };

                    h1Title.textContent = 'ğŸš§ ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨';
                    h1Title.style.color = 'var(--error-color)';
                    statusMessage.textContent = 'ê²°ì œ ìŠ¹ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    approvalStatusDisplay.textContent = 'ìŠ¹ì¸ ì‹¤íŒ¨ (ì‹œë®¬ë ˆì´ì…˜)';
                    approvalStatusDisplay.className = 'status-error';
                    orderNameDisplay.textContent = `í”Œëœ ${orderIdFromQuery.slice(-4)} êµ¬ë… (ì‹œë®¬ë ˆì´ì…˜)`;
                    finalAmountDisplay.textContent = parseInt(amountFromQuery).toLocaleString() + ' ì› (ê²°ì œ ì‹¤íŒ¨)';
                    paymentMethodDisplay.textContent = 'N/A';

                    errorCodeBlock.style.display = 'block';
                    errorMessageBlock.style.display = 'block';
                    errorCodeDisplay.textContent = simulationResponse.code;
                    errorMessageDisplay.textContent = simulationResponse.message;

                    retryLink.href = `payment.html?plan=${encodeURIComponent('ì´ì „ í”Œëœ')}&price=${amountFromQuery}&planName=${encodeURIComponent('ì´ì „ í”Œëœ êµ¬ë…')}`; // ì´ì „ ì •ë³´ë¡œ ì¬ì‹œë„ ë§í¬ (ì •í™•í•œ plan, planName í•„ìš”)
                    retryLink.style.display = 'inline-block';
                    console.error("ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨ (ì‹œë®¬ë ˆì´ì…˜):", simulationResponse);
                }

            } catch (error) {
                h1Title.textContent = 'ğŸš§ ì‹œìŠ¤í…œ ì˜¤ë¥˜';
                h1Title.style.color = 'var(--error-color)';
                statusMessage.textContent = 'ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                approvalStatusDisplay.textContent = 'ì‹œìŠ¤í…œ ì˜¤ë¥˜';
                approvalStatusDisplay.className = 'status-error';
                errorMessageBlock.style.display = 'block';
                errorMessageDisplay.textContent = `ì˜¤ë¥˜ ë‚´ìš©: ${error.message}. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`;
                console.error('ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
            } finally {
                loadingMessage.style.display = 'none';
                approvalResultBlock.style.display = 'block';
                homeButton.style.display = 'inline-block';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²°ì œ ìŠ¹ì¸ í•¨ìˆ˜ ìë™ í˜¸ì¶œ
        approvePayment();
    </script>
</body>
</html>
